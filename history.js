(()=>{function p(s,t="application/octet-stream"){const a=atob(s),e=a.length,o=new Uint8Array(e);for(let n=0;n<e;n++)o[n]=a.charCodeAt(n);return new Blob([o],{type:t})}function l(s){return new Promise((t,a)=>{const e=Math.random().toString(36).substring(7),o=n=>{n.detail.reqId===e&&(document.removeEventListener("iPusnas_Bridge_Res",o),t(n.detail.response))};document.addEventListener("iPusnas_Bridge_Res",o),document.dispatchEvent(new CustomEvent("iPusnas_Bridge_Req",{detail:{reqId:e,message:s}})),setTimeout(()=>{document.removeEventListener("iPusnas_Bridge_Res",o),a(new Error("Bridge request timed out"))},3e4)})}async function b(s){const t=await l({action:"GET_FILE",bookId:s});return t&&t.success?{file:p(t.fileBase64),ext:t.ext}:null}async function m(s,t){const a=await b(s);if(!a)throw new Error("File tidak ditemukan: "+s);const e=a.file,o=a.ext||"";t=t+(o?"."+o:"");const n=URL.createObjectURL(e),r=document.createElement("a");r.href=n,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n),console.log("File berhasil diunduh:",t)}async function h(s){const t=await l({action:"CHECK_EXIST",bookId:s});return t&&t.exists}function f(s,t){l({action:"UPDATE_METADATA",bookId:s,metadata:t})}(function(){const s=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(a,e,o,n,r){return this._url=e,s.apply(this,arguments)},XMLHttpRequest.prototype.send=function(a){return this.addEventListener("load",async function(){if(this._url&&this._url.includes("/api/webhook/book-detail"))try{const e=JSON.parse(this.responseText);if(e&&e.data.id&&e.data.book_title){const o=e.data.id,n=e.data.book_title;localStorage.setItem("last_book_id",o),await h(o)&&(console.log("File ada di DB:",n),f(o,{title:n,author:e.data.book_author,cover:e.data.cover_url}),document.querySelectorAll(".ant-row.button-bottom").forEach(c=>{if(!c.querySelector(".custom-download-col")){const d=document.createElement("div");d.className="ant-col mt-md custom-download-col";const i=document.createElement("button");i.type="button",i.className="ant-btn ant-btn-default button-borrow",i.innerHTML="<span>Download</span>",i.addEventListener("click",()=>{m(o,n).catch(console.error)}),d.appendChild(i);const u=c.querySelector(".ant-col");u?c.insertBefore(d,u):c.appendChild(d)}}))}}catch(e){console.error("Failed parse XHR response",e)}}),t.apply(this,arguments)}})()})();
