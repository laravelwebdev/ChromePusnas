(()=>{function f(s,e="application/octet-stream"){const n=atob(s),r=n.length,t=new Uint8Array(r);for(let o=0;o<r;o++)t[o]=n.charCodeAt(o);return new Blob([t],{type:e})}function u(s){return new Promise((e,n)=>{const r=Math.random().toString(36).substring(7),t=o=>{o.detail.reqId===r&&(document.removeEventListener("iPusnas_Bridge_Res",t),e(o.detail.response))};document.addEventListener("iPusnas_Bridge_Res",t),document.dispatchEvent(new CustomEvent("iPusnas_Bridge_Req",{detail:{reqId:r,message:s}})),setTimeout(()=>{document.removeEventListener("iPusnas_Bridge_Res",t),n(new Error("Bridge request timed out"))},3e4)})}async function h(s){const e=await u({action:"GET_FILE",bookId:s});return e&&e.success?{file:f(e.fileBase64),ext:e.ext}:null}async function y(s,e){const n=await h(s);if(!n)throw new Error("File tidak ditemukan: "+s);const r=n.file,t=n.ext||"";e=e+(t?"."+t:"");const o=URL.createObjectURL(r),a=document.createElement("a");a.href=o,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o)}async function E(s){const e=await u({action:"CHECK_EXIST",bookId:s});return e&&e.exists}function w(s,e){u({action:"UPDATE_METADATA",bookId:s,metadata:e})}(function(){const s=XMLHttpRequest.prototype.open,e=XMLHttpRequest.prototype.send;let n=null;XMLHttpRequest.prototype.open=function(r,t,o,a,_){return this._url=t,s.apply(this,arguments)},XMLHttpRequest.prototype.send=function(r){return this.addEventListener("load",async function(){if(this._url&&this._url.includes("/book-detail"))try{const t=JSON.parse(this.responseText);if(t&&t.data.id&&t.data.book_title){const o=t.data.id,a=t.data.book_title;if(localStorage.setItem("last_book_id",o),await E(o)){w(o,{title:a,author:t.data.book_author,cover:t.data.cover_url}),n&&(n.disconnect(),n=null);const p=()=>{const b=document.querySelectorAll(".ant-row.button-bottom");let c=!1;return b.length>0&&b.forEach(d=>{if(!d.querySelector(".custom-download-col")){const l=document.createElement("div");l.className="ant-col mt-md custom-download-col";const i=document.createElement("button");i.type="button",i.className="ant-btn ant-btn-default button-borrow",i.innerHTML="<span>Download</span>",i.addEventListener("click",()=>{y(o,a).catch(console.error)}),l.appendChild(i);const m=d.querySelector(".ant-col");m?d.insertBefore(l,m):d.appendChild(l),c=!0}}),c};if(p())return;n=new MutationObserver((b,c)=>{p()&&(c.disconnect(),n=null)}),n.observe(document.body,{childList:!0,subtree:!0})}}}catch{}}),e.apply(this,arguments)}})()})();
