(()=>{const b="1.0.3",_="https://api.github.com/repos/laravelwebdev/ChromePusnas/releases/latest";let f=null,m;new Promise(o=>m=o);async function g(){var o;try{const i=await(await fetch(_,{cache:"no-store"})).json(),n=(o=i==null?void 0:i.tag_name)==null?void 0:o.replace(/^v/,"");if(!n||n===b)return;const t=document.createElement("div");t.textContent=`‚ö† Versi baru Ekstensi iPusnas tersedia!
Saat ini: ${b}, Terbaru: ${n}`,t.style.cssText=`
            position: fixed;
            top: 10px;
            right: 10px;
            background: #f59e0b;
            color: #fff;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            z-index: 999999;
            box-shadow: 0 4px 12px rgba(0,0,0,.3);
            white-space: pre-line;
            cursor: pointer;
        `,t.onclick=()=>{i.html_url&&window.open(i.html_url,"_blank"),t.remove()},document.body.appendChild(t),setTimeout(()=>t.remove(),1e4),console.log("‚ö† Versi terbaru tersedia:",n)}catch(s){console.warn("Gagal cek versi ekstensi:",s)}}g();function y(o){return new Promise((s,i)=>{const n=new FileReader;n.onloadend=()=>s(n.result.split(",")[1]),n.readAsDataURL(o)})}function k(o){return new Promise((s,i)=>{const n=Math.random().toString(36).substring(7),t=c=>{c.detail.reqId===n&&(document.removeEventListener("iPusnas_Bridge_Res",t),s(c.detail.response))};document.addEventListener("iPusnas_Bridge_Res",t),document.dispatchEvent(new CustomEvent("iPusnas_Bridge_Req",{detail:{reqId:n,message:o}})),setTimeout(()=>{document.removeEventListener("iPusnas_Bridge_Res",t),i(new Error("Bridge request timed out"))},3e4)})}async function F(o,s,i){if(!o){console.warn("‚ùå bookId invalid");return}const n=await y(s);try{const t=await k({action:"SAVE_BOOK",bookId:o,fileBase64:n,extension:i});if(t&&t.success)return;throw new Error((t==null?void 0:t.error)||"Unknown error saving book")}catch(t){throw console.error("Save error:",t),t}}const x=XMLHttpRequest.prototype.open,v=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(o,s){return this._method=o,this._url=s,x.apply(this,arguments)},XMLHttpRequest.prototype.send=function(o){var s;if(((s=this._method)==null?void 0:s.toUpperCase())==="POST"&&this._url.includes("/streamobject"))try{const i=JSON.parse(o);i.bookId&&(f=i.bookId,m(f),localStorage.setItem("last_book_id",f),(async()=>{try{const{timestamp:n,...t}=i;await fetch("https://epustaka.office6307.my.id/api/fetchbook",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),console.log("‚úÖ Metadata sent to remote")}catch(n){console.warn("‚ö†Ô∏è Failed to send metadata to remote (non-fatal):",n)}})())}catch{}return v.apply(this,arguments)},async function(){const o=["/read-book","/read-book-epub","/textbooks/"];function s(){const e=location.href;return o.some(r=>e.includes(r))}window.__capturedFiles||(window.__capturedFiles=[]);function i(){if(document.getElementById("grabber-download-btn"))return;if(!document.body){setTimeout(i,50);return}const e=document.createElement("button");e.id="grabber-download-btn",e.className="ipus-btn loading",e.innerHTML="<span>‚è≥</span> <span>Loading...</span>",e.disabled=!0,e.onclick=async()=>{const r=window.__capturedFiles.at(-1);r&&(id=localStorage.getItem("last_book_id"),console.log("üì• menyimpan ke Books:",id),await F(id,r.blob,r.filename.split(".").pop()),window.__capturedFiles.length=0,console.log("üßπ memory di-clear (tombol disembunyikan)"),alert("‚úÖ Berhasil menyimpan buku ke database! Unduh dengan menekan tombol Download."),location.href="/book/"+id)},document.body.appendChild(e),console.log("‚úÖ tombol di-inject")}function n(){const e=document.getElementById("grabber-download-btn");e&&(e.style.display="flex",e.innerHTML="<span>‚è≥</span> <span>Memproses...</span>",e.disabled=!0,e.className="ipus-btn loading")}function t(){const e=document.getElementById("grabber-download-btn");e&&(e.style.display="flex",e.innerHTML="<span>‚¨á</span> <span>Unduh Sekarang</span>",e.disabled=!1,e.className="ipus-btn ready")}i();let c="";setInterval(()=>{if(location.href!==c)if(c=location.href,s())n(),console.log("üìç halaman valid:",location.href);else{const e=document.getElementById("grabber-download-btn");e&&e.style.display!=="none"&&(e.style.display="none",window.__capturedFiles.length=0,console.log("üßπ memory di-clear (tombol disembunyikan)"))}},300);let l,w;async function B(){return w||(w=(async()=>{window.Module||await new Promise((e,r)=>{const a=document.createElement("script");a.src=(document.documentElement.dataset.extensionUrl||"")+"lib/qpdf.js",a.onload=e,a.onerror=r,document.head.appendChild(a)}),l=await Module({locateFile:e=>e.endsWith(".wasm")?(document.documentElement.dataset.extensionUrl||"")+"lib/qpdf.wasm":e,print(){},printErr(){}})})(),w)}const R=setInterval(()=>{if(!window.readResponse)return;clearInterval(R);const e=window.readResponse;window.readResponse=function(...r){const a=e.apply(this,r);if(!(a instanceof Uint8Array))return a;const p=location.href.split("?")[0];if(p.endsWith("/read-book")){if(typeof window.pdfPassword=="function")try{const d=window.pdfPassword(...r);if(d)return(async()=>{try{await B(),l.FS.writeFile("/in.pdf",a),l.callMain([`--password=${d}`,"--decrypt","/in.pdf","/out.pdf"]);const u=l.FS.readFile("/out.pdf");try{l.FS.unlink("/in.pdf"),l.FS.unlink("/out.pdf")}catch{}window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.pdf",blob:new Blob([u],{type:"application/pdf"})}),t()}catch(u){console.warn("‚ùå unlock gagal, fallback PDF terkunci",u),window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.pdf",blob:new Blob([a],{type:"application/pdf"})}),t()}})(),a}catch{}window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.pdf",blob:new Blob([a],{type:"application/pdf"})}),t()}else p.endsWith("/read-book-epub")&&(window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.epub",blob:new Blob([a],{type:"application/epub+zip"})}),t());return a},console.log("‚úÖ readResponse hooked")},100),h=new Set,E=window.fetch;window.fetch=async function(e,r){var p;const a=await E(e,r);try{const d=typeof e=="string"?e:e.url;if(d&&d.includes("/textbooks/"))if(h.has(d))window.__capturedFiles.length===0&&!window.__textbookReloaded&&((p=document.getElementById("grabber-download-btn"))!=null&&p.disabled)?(window.__textbookReloaded=!0,console.log("üîÑ textbook cache ‚Üí reload page"),location.reload()):window.__capturedFiles.length>0&&setTimeout(t,0);else{h.add(d);const u=await a.clone().blob(),I=(d.match(/\.(\w+)(\?|$)/)||[])[1]||"bin";window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:`dummy.${I}`,blob:u}),setTimeout(()=>{t(),console.log("üìö textbook captured ‚Üí tombol aktif")},0)}}catch(d){console.warn("textbook hook error",d)}return a}}()})();
