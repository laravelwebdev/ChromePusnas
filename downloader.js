(()=>{const b="1.2.0",_="https://api.github.com/repos/laravelwebdev/ChromePusnas/releases/latest";let f=null,m;new Promise(n=>m=n);async function g(){var n;try{const o=await(await fetch(_,{cache:"no-store"})).json(),a=(n=o==null?void 0:o.tag_name)==null?void 0:n.replace(/^v/,"");if(!a||a===b)return;const t=document.createElement("div");t.textContent=`⚠ Versi baru Ekstensi iPusnas tersedia!
Saat ini: ${b}, Terbaru: ${a}`,t.style.cssText=`
            position: fixed;
            top: 10px;
            right: 10px;
            background: #f59e0b;
            color: #fff;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            z-index: 999999;
            box-shadow: 0 4px 12px rgba(0,0,0,.3);
            white-space: pre-line;
            cursor: pointer;
        `,t.onclick=()=>{o.html_url&&window.open(o.html_url,"_blank"),t.remove()},document.body.appendChild(t),setTimeout(()=>t.remove(),1e4)}catch(s){console.warn("Gagal cek versi ekstensi:",s)}}g();function y(n){return new Promise((s,o)=>{const a=new FileReader;a.onloadend=()=>s(a.result.split(",")[1]),a.readAsDataURL(n)})}function k(n){return new Promise((s,o)=>{const a=Math.random().toString(36).substring(7),t=c=>{c.detail.reqId===a&&(document.removeEventListener("iPusnas_Bridge_Res",t),s(c.detail.response))};document.addEventListener("iPusnas_Bridge_Res",t),document.dispatchEvent(new CustomEvent("iPusnas_Bridge_Req",{detail:{reqId:a,message:n}})),setTimeout(()=>{document.removeEventListener("iPusnas_Bridge_Res",t),o(new Error("Bridge request timed out"))},3e4)})}async function F(n,s,o){if(!n){console.warn("❌ bookId invalid");return}const a=await y(s);try{const t=await k({action:"SAVE_BOOK",bookId:n,fileBase64:a,extension:o});if(t&&t.success)return;throw new Error((t==null?void 0:t.error)||"Unknown error saving book")}catch(t){throw console.error("Save error:",t),t}}const x=XMLHttpRequest.prototype.open,v=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(n,s){return this._method=n,this._url=s,x.apply(this,arguments)},XMLHttpRequest.prototype.send=function(n){var s;if(((s=this._method)==null?void 0:s.toUpperCase())==="POST"&&this._url.includes("/streamobject"))try{const o=JSON.parse(n);o.bookId&&(f=o.bookId,m(f),localStorage.setItem("last_book_id",f))}catch{}return v.apply(this,arguments)},async function(){const n=["/read-book","/read-book-epub","/textbooks/"];function s(){const e=location.href;return n.some(r=>e.includes(r))}window.__capturedFiles||(window.__capturedFiles=[]);function o(){if(document.getElementById("grabber-download-btn"))return;if(!document.body){setTimeout(o,50);return}const e=document.createElement("button");e.id="grabber-download-btn",e.className="ipus-btn ipus-loading",e.innerHTML="<span>⏳</span> <span>Loading...</span>",e.disabled=!0,e.onclick=async()=>{const r=window.__capturedFiles.at(-1);r&&(id=localStorage.getItem("last_book_id"),await F(id,r.blob,r.filename.split(".").pop()),window.__capturedFiles.length=0,alert("✅ Berhasil menyimpan buku ke database! Unduh dengan menekan tombol Download."),location.href="/book/"+id)},document.body.appendChild(e)}function a(){const e=document.getElementById("grabber-download-btn");e&&(e.style.display="flex",e.innerHTML="<span>⏳</span> <span>Tunggu yaa...</span>",e.disabled=!0,e.className="ipus-btn ipus-loading")}function t(){const e=document.getElementById("grabber-download-btn");e&&(e.style.display="flex",e.innerHTML="<span>⬇</span> <span>Tambahkan ke Koleksi</span>",e.disabled=!1,e.className="ipus-btn ipus-ready")}o();let c="";setInterval(()=>{if(location.href!==c)if(c=location.href,s())a();else{const e=document.getElementById("grabber-download-btn");e&&e.style.display!=="none"&&(e.style.display="none",window.__capturedFiles.length=0)}},300);let l,w;async function B(){return w||(w=(async()=>{window.Module||await new Promise((e,r)=>{const i=document.createElement("script");i.src=(document.documentElement.dataset.extensionUrl||"")+"lib/qpdf.js",i.onload=e,i.onerror=r,document.head.appendChild(i)}),l=await Module({locateFile:e=>e.endsWith(".wasm")?(document.documentElement.dataset.extensionUrl||"")+"lib/qpdf.wasm":e,print(){},printErr(){}})})(),w)}const E=setInterval(()=>{if(!window.readResponse)return;clearInterval(E);const e=window.readResponse;window.readResponse=function(...r){const i=e.apply(this,r);if(!(i instanceof Uint8Array))return i;const u=location.href.split("?")[0];if(u.endsWith("/read-book")){if(typeof window.pdfPassword=="function")try{const d=window.pdfPassword(...r);if(d)return(async()=>{try{await B(),l.FS.writeFile("/in.pdf",i),l.callMain([`--password=${d}`,"--decrypt","/in.pdf","/out.pdf"]);const p=l.FS.readFile("/out.pdf");try{l.FS.unlink("/in.pdf"),l.FS.unlink("/out.pdf")}catch{}window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.pdf",blob:new Blob([p],{type:"application/pdf"})}),t()}catch(p){console.warn("❌ unlock gagal, fallback PDF terkunci",p),window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.pdf",blob:new Blob([i],{type:"application/pdf"})}),t()}})(),i}catch{}window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.pdf",blob:new Blob([i],{type:"application/pdf"})}),t()}else u.endsWith("/read-book-epub")&&(window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.epub",blob:new Blob([i],{type:"application/epub+zip"})}),t());return i}},100),h=new Set,R=window.fetch;window.fetch=async function(e,r){var u;const i=await R(e,r);try{const d=typeof e=="string"?e:e.url;if(d&&d.includes("/textbooks/"))if(h.has(d))window.__capturedFiles.length===0&&!window.__textbookReloaded&&((u=document.getElementById("grabber-download-btn"))!=null&&u.disabled)?(window.__textbookReloaded=!0,location.reload()):window.__capturedFiles.length>0&&setTimeout(t,0);else{h.add(d);const p=await i.clone().blob(),I=(d.match(/\.(\w+)(\?|$)/)||[])[1]||"bin";window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:`dummy.${I}`,blob:p}),setTimeout(()=>{t()},0)}}catch(d){console.warn("textbook hook error",d)}return i}}()})();
