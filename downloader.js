(()=>{const b="2.0.0",g="https://api.github.com/repos/laravelwebdev/ChromePusnas/releases/latest";let f=null,m;new Promise(o=>m=o);async function y(){var o;try{const i=await(await fetch(g,{cache:"no-store"})).json(),s=(o=i==null?void 0:i.tag_name)==null?void 0:o.replace(/^v/,"");if(!s||s===b)return;const t=document.createElement("div");t.textContent=`⚠ Versi baru Ekstensi iPusnas tersedia!
Saat ini: ${b}, Terbaru: ${s}`,t.style.cssText=`
            position: fixed;
            top: 10px;
            right: 10px;
            background: #f59e0b;
            color: #fff;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            z-index: 999999;
            box-shadow: 0 4px 12px rgba(0,0,0,.3);
            white-space: pre-line;
            cursor: pointer;
        `,t.onclick=()=>{i.html_url&&window.open(i.html_url,"_blank"),t.remove()},document.body.appendChild(t),setTimeout(()=>t.remove(),1e4)}catch(a){console.log("Gagal cek versi ekstensi:",a)}}y();function k(o){return new Promise((a,i)=>{const s=new FileReader;s.onloadend=()=>a(s.result.split(",")[1]),s.readAsDataURL(o)})}function _(o){return new Promise((a,i)=>{const s=Math.random().toString(36).substring(7),t=u=>{u.detail.reqId===s&&(document.removeEventListener("iPusnas_Bridge_Res",t),a(u.detail.response))};document.addEventListener("iPusnas_Bridge_Res",t),document.dispatchEvent(new CustomEvent("iPusnas_Bridge_Req",{detail:{reqId:s,message:o}})),setTimeout(()=>{document.removeEventListener("iPusnas_Bridge_Res",t),i(new Error("Bridge request timed out"))},3e4)})}async function F(o,a,i){if(!o){console.log("❌ bookId invalid");return}const s=await k(a);try{const t=await _({action:"SAVE_BOOK",bookId:o,fileBase64:s,extension:i});if(t&&t.success)return;throw(t==null?void 0:t.error)==="STORAGE_NOT_CONFIGURED"?new Error("STORAGE_NOT_CONFIGURED"):new Error((t==null?void 0:t.error)||"Unknown error saving book")}catch(t){throw t.message!=="STORAGE_NOT_CONFIGURED"&&console.log("Save error:",t),t}}const E=XMLHttpRequest.prototype.open,R=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(o,a){return this._method=o,this._url=a,E.apply(this,arguments)},XMLHttpRequest.prototype.send=function(o){var a;if(((a=this._method)==null?void 0:a.toUpperCase())==="POST"&&this._url.includes("/streamobject"))try{const i=JSON.parse(o);i.bookId&&(f=i.bookId,m(f),localStorage.setItem("last_book_id",f))}catch{}return R.apply(this,arguments)},async function(){const o=["/read-book","/read-book-epub","/textbooks/"];function a(){const e=location.href;return o.some(r=>e.includes(r))}window.__capturedFiles||(window.__capturedFiles=[]);function i(){if(document.getElementById("grabber-download-btn"))return;if(!document.body){setTimeout(i,50);return}const e=document.createElement("button");e.id="grabber-download-btn",e.className="ipus-btn ipus-loading",e.innerHTML="<span>⏳</span> <span>Loading...</span>",e.disabled=!0,e.onclick=async()=>{const r=window.__capturedFiles.at(-1);if(!r)return;const n=localStorage.getItem("last_book_id");try{await F(n,r.blob,r.filename.split(".").pop()),window.__capturedFiles.length=0,alert("✅ Berhasil menyimpan buku ke database! Unduh dengan menekan tombol Download.");try{n&&(location.href="/book/"+n)}catch{}}catch(l){l.message==="STORAGE_NOT_CONFIGURED"?await _({action:"OPEN_LIBRARY"}):alert("Gagal menyimpan: "+l.message)}},document.body.appendChild(e)}function s(){const e=document.getElementById("grabber-download-btn");e&&(e.style.display="flex",e.innerHTML="<span>⏳</span> <span>Tunggu yaa...</span>",e.disabled=!0,e.className="ipus-btn ipus-loading")}function t(){const e=document.getElementById("grabber-download-btn");e&&(e.style.display="flex",e.innerHTML="<span>⬇</span> <span>Tambahkan ke Koleksi</span>",e.disabled=!1,e.className="ipus-btn ipus-ready")}i();let u="";setInterval(()=>{if(location.href!==u)if(u=location.href,a())s();else{const e=document.getElementById("grabber-download-btn");e&&e.style.display!=="none"&&(e.style.display="none",window.__capturedFiles.length=0)}},300);let c,w;async function I(){return w||(w=(async()=>{window.Module||await new Promise((e,r)=>{const n=document.createElement("script");n.src=(document.documentElement.dataset.extensionUrl||"")+"lib/qpdf.js",n.onload=e,n.onerror=r,document.head.appendChild(n)}),c=await Module({locateFile:e=>e.endsWith(".wasm")?(document.documentElement.dataset.extensionUrl||"")+"lib/qpdf.wasm":e,print(){},printErr(){}})})(),w)}const x=setInterval(()=>{if(!window.readResponse)return;clearInterval(x);const e=window.readResponse;window.readResponse=function(...r){const n=e.apply(this,r);if(!(n instanceof Uint8Array))return n;const l=location.href.split("?")[0];if(l.endsWith("/read-book")){if(typeof window.pdfPassword=="function")try{const d=window.pdfPassword(...r);if(d)return(async()=>{try{await I(),c.FS.writeFile("/in.pdf",n),c.callMain([`--password=${d}`,"--decrypt","/in.pdf","/out.pdf"]);const p=c.FS.readFile("/out.pdf");try{c.FS.unlink("/in.pdf"),c.FS.unlink("/out.pdf")}catch{}window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.pdf",blob:new Blob([p],{type:"application/pdf"})}),t()}catch(p){console.log("❌ unlock gagal, fallback PDF terkunci",p),window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.pdf",blob:new Blob([n],{type:"application/pdf"})}),t()}})(),n}catch{}window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.pdf",blob:new Blob([n],{type:"application/pdf"})}),t()}else l.endsWith("/read-book-epub")&&(window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.epub",blob:new Blob([n],{type:"application/epub+zip"})}),t());return n}},100),h=new Set,B=window.fetch;window.fetch=async function(e,r){var l;const n=await B(e,r);try{const d=typeof e=="string"?e:e.url;if(d&&d.includes("/textbooks/"))if(h.has(d))window.__capturedFiles.length===0&&!window.__textbookReloaded&&((l=document.getElementById("grabber-download-btn"))!=null&&l.disabled)?(window.__textbookReloaded=!0,location.reload()):window.__capturedFiles.length>0&&setTimeout(t,0);else{h.add(d);const p=await n.clone().blob(),T=(d.match(/\.(\w+)(\?|$)/)||[])[1]||"bin";window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:`dummy.${T}`,blob:p}),setTimeout(()=>{t()},0)}}catch(d){console.log("textbook hook error",d)}return n}}()})();
