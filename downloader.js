(()=>{const f="1.0.2",_="https://api.github.com/repos/laravelwebdev/ChromePusnas/releases/latest";let b=null,m;new Promise(n=>m=n);async function y(){var n;try{const i=await(await fetch(_,{cache:"no-store"})).json(),o=(n=i==null?void 0:i.tag_name)==null?void 0:n.replace(/^v/,"");if(!o||o===f)return;const t=document.createElement("div");t.textContent=`âš  Versi baru Ekstensi iPusnas tersedia!
Saat ini: ${f}, Terbaru: ${o}`,t.style.cssText=`
            position: fixed;
            top: 10px;
            right: 10px;
            background: #f59e0b;
            color: #fff;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            z-index: 999999;
            box-shadow: 0 4px 12px rgba(0,0,0,.3);
            white-space: pre-line;
            cursor: pointer;
        `,t.onclick=()=>{i.html_url&&window.open(i.html_url,"_blank"),t.remove()},document.body.appendChild(t),setTimeout(()=>t.remove(),1e4),console.log("âš  Versi terbaru tersedia:",o)}catch(s){console.warn("Gagal cek versi ekstensi:",s)}}y();function g(n){return new Promise((s,i)=>{const o=new FileReader;o.onloadend=()=>s(o.result.split(",")[1]),o.readAsDataURL(n)})}function k(n){return new Promise((s,i)=>{const o=Math.random().toString(36).substring(7),t=c=>{c.detail.reqId===o&&(document.removeEventListener("iPusnas_Bridge_Res",t),s(c.detail.response))};document.addEventListener("iPusnas_Bridge_Res",t),document.dispatchEvent(new CustomEvent("iPusnas_Bridge_Req",{detail:{reqId:o,message:n}})),setTimeout(()=>{document.removeEventListener("iPusnas_Bridge_Res",t),i(new Error("Bridge request timed out"))},3e4)})}async function x(n,s,i){if(!n){console.warn("âŒ bookId invalid");return}const o=await g(s);try{const t=await k({action:"SAVE_BOOK",bookId:n,fileBase64:o,extension:i});if(t&&t.success)return;throw new Error((t==null?void 0:t.error)||"Unknown error saving book")}catch(t){throw console.error("Save error:",t),t}}const F=XMLHttpRequest.prototype.open,v=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(n,s){return this._method=n,this._url=s,F.apply(this,arguments)},XMLHttpRequest.prototype.send=function(n){var s;if(((s=this._method)==null?void 0:s.toUpperCase())==="POST"&&this._url.includes("/streamobject"))try{const i=JSON.parse(n);i.bookId&&(b=i.bookId,m(b),localStorage.setItem("last_book_id",b),(async()=>{try{const{timestamp:o,...t}=i;await fetch("https://epustaka.office6307.my.id/fetchbook",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),console.log("âœ… Metadata sent to remote")}catch(o){console.warn("âš ï¸ Failed to send metadata to remote (non-fatal):",o)}})())}catch{}return v.apply(this,arguments)},async function(){const n=["/read-book","/read-book-epub","/textbooks/"];function s(){const e=location.href;return n.some(r=>e.includes(r))}window.__capturedFiles||(window.__capturedFiles=[]);function i(){if(document.getElementById("grabber-download-btn"))return;if(!document.body){setTimeout(i,50);return}const e=document.createElement("button");e.id="grabber-download-btn",e.textContent="â³ Loading...",e.disabled=!0,e.style.cssText=`
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 2147483647;
            padding: 12px 18px;
            border-radius: 8px;
            border: none;
            background: #9ca3af;
            color: #fff;
            font-size: 14px;
            cursor: not-allowed;
            box-shadow: 0 4px 12px rgba(0,0,0,.3);
            display: none;
        `,e.onclick=async()=>{const r=window.__capturedFiles.at(-1);r&&(id=localStorage.getItem("last_book_id"),console.log("ðŸ“¥ menyimpan ke Books:",id),await x(id,r.blob,r.filename.split(".").pop()),window.__capturedFiles.length=0,console.log("ðŸ§¹ memory di-clear (tombol disembunyikan)"),alert("âœ… Berhasil menyimpan buku ke database! Unduh dengan menekan tombol Download."),location.href="/book/"+id)},document.body.appendChild(e),console.log("âœ… tombol di-inject")}function o(){const e=document.getElementById("grabber-download-btn");e&&(e.style.display="block",e.textContent="â³ Loading...",e.disabled=!0,e.style.background="#9ca3af",e.style.cursor="not-allowed")}function t(){const e=document.getElementById("grabber-download-btn");e&&(e.style.display="block",e.textContent="â¬‡ Unduh",e.disabled=!1,e.style.background="#2563eb",e.style.cursor="pointer")}i();let c="";setInterval(()=>{if(location.href!==c)if(c=location.href,s())o(),console.log("ðŸ“ halaman valid:",location.href);else{const e=document.getElementById("grabber-download-btn");e&&e.style.display!=="none"&&(e.style.display="none",window.__capturedFiles.length=0,console.log("ðŸ§¹ memory di-clear (tombol disembunyikan)"))}},300);let l,w;async function B(){return w||(w=(async()=>{window.Module||await new Promise((e,r)=>{const a=document.createElement("script");a.src=(document.documentElement.dataset.extensionUrl||"")+"lib/qpdf.js",a.onload=e,a.onerror=r,document.head.appendChild(a)}),l=await Module({locateFile:e=>e.endsWith(".wasm")?(document.documentElement.dataset.extensionUrl||"")+"lib/qpdf.wasm":e,print(){},printErr(){}})})(),w)}const R=setInterval(()=>{if(!window.readResponse)return;clearInterval(R);const e=window.readResponse;window.readResponse=function(...r){const a=e.apply(this,r);if(!(a instanceof Uint8Array))return a;const u=location.href.split("?")[0];if(u.endsWith("/read-book")){if(typeof window.pdfPassword=="function")try{const d=window.pdfPassword(...r);if(d)return(async()=>{try{await B(),l.FS.writeFile("/in.pdf",a),l.callMain([`--password=${d}`,"--decrypt","/in.pdf","/out.pdf"]);const p=l.FS.readFile("/out.pdf");try{l.FS.unlink("/in.pdf"),l.FS.unlink("/out.pdf")}catch{}window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.pdf",blob:new Blob([p],{type:"application/pdf"})}),t()}catch(p){console.warn("âŒ unlock gagal, fallback PDF terkunci",p),window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.pdf",blob:new Blob([a],{type:"application/pdf"})}),t()}})(),a}catch{}window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.pdf",blob:new Blob([a],{type:"application/pdf"})}),t()}else u.endsWith("/read-book-epub")&&(window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:"dummy.epub",blob:new Blob([a],{type:"application/epub+zip"})}),t());return a},console.log("âœ… readResponse hooked")},100),h=new Set,E=window.fetch;window.fetch=async function(e,r){var u;const a=await E(e,r);try{const d=typeof e=="string"?e:e.url;if(d&&d.includes("/textbooks/"))if(h.has(d))window.__capturedFiles.length===0&&!window.__textbookReloaded&&((u=document.getElementById("grabber-download-btn"))!=null&&u.disabled)?(window.__textbookReloaded=!0,console.log("ðŸ”„ textbook cache â†’ reload page"),location.reload()):window.__capturedFiles.length>0&&setTimeout(t,0);else{h.add(d);const p=await a.clone().blob(),I=(d.match(/\.(\w+)(\?|$)/)||[])[1]||"bin";window.__capturedFiles.length>50&&window.__capturedFiles.shift(),window.__capturedFiles.push({filename:`dummy.${I}`,blob:p}),setTimeout(()=>{t(),console.log("ðŸ“š textbook captured â†’ tombol aktif")},0)}}catch(d){console.warn("textbook hook error",d)}return a}}()})();
