chrome.action.onClicked.addListener(()=>{chrome.tabs.create({url:"library.html"})});const x="LibraryDB",b="books",i="booklist",y=2;function f(){return new Promise((o,u)=>{const e=indexedDB.open(x,y);e.onupgradeneeded=t=>{const r=t.target.result;r.objectStoreNames.contains(b)||r.createObjectStore(b,{keyPath:"bookId"}),r.objectStoreNames.contains(i)||r.createObjectStore(i,{keyPath:"bookId"})},e.onsuccess=t=>o(t.target.result),e.onerror=t=>u(t.target.error)})}function I(o,u="application/octet-stream"){const e=atob(o),t=e.length,r=new Uint8Array(t);for(let n=0;n<t;n++)r[n]=e.charCodeAt(n);return new Blob([r],{type:u})}function E(o){return new Promise((u,e)=>{const t=new FileReader;t.onloadend=()=>u(t.result.split(",")[1]),t.readAsDataURL(o)})}chrome.runtime.onMessage.addListener((o,u,e)=>{if(o.action==="SAVE_BOOK")return(async()=>{try{const{bookId:t,fileBase64:r,extension:n}=o,c=await f(),s=I(r),a=c.transaction([b,i],"readwrite"),k=a.objectStore(b),l=a.objectStore(i);k.put({bookId:t,file:s,ext:n,createdAt:Date.now()});const S=l.get(t);S.onsuccess=()=>{const d=S.result||{bookId:t};d.bookId=t,l.put(d)},S.onerror=()=>l.put({bookId:t}),a.oncomplete=()=>e({success:!0}),a.onerror=d=>e({success:!1,error:d.target.error.message})}catch(t){console.error("Bg Save Error:",t),e({success:!1,error:t.message})}})(),!0;if(o.action==="CHECK_EXIST")return(async()=>{try{const c=(await f()).transaction([i],"readonly").objectStore(i).get(o.bookId);c.onsuccess=()=>{const s=c.result!==void 0;e({exists:s})},c.onerror=()=>e({exists:!1})}catch{e({exists:!1})}})(),!0;if(o.action==="UPDATE_METADATA")return(async()=>{try{const{bookId:t,metadata:r}=o,c=(await f()).transaction([i],"readwrite"),s=c.objectStore(i),a=s.get(t);a.onsuccess=()=>{const l={...a.result||{bookId:t},...r};s.put(l)},c.oncomplete=()=>e({success:!0}),c.onerror=()=>e({success:!1})}catch{e({success:!1})}})(),!0;if(o.action==="GET_FILE")return(async()=>{try{const c=(await f()).transaction([b],"readonly").objectStore(b).get(o.bookId);c.onsuccess=async()=>{const s=c.result;if(s&&s.file){const a=await E(s.file);e({success:!0,fileBase64:a,ext:s.ext})}else e({success:!1})},c.onerror=()=>e({success:!1})}catch{e({success:!1})}})(),!0});
