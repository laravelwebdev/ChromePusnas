import{i,f as c,h as n,g as u,u as f,a as b}from"./storage.js";chrome.action.onClicked.addListener(()=>{chrome.tabs.create({url:"library.html"})});function E(r,l="application/octet-stream"){const a=atob(r),t=a.length,o=new Uint8Array(t);for(let e=0;e<t;e++)o[e]=a.charCodeAt(e);return new Blob([o],{type:l})}function h(r){return new Promise((l,a)=>{const t=new FileReader;t.onloadend=()=>l(t.result.split(",")[1]),t.readAsDataURL(r)})}i().catch(r=>console.log("Bg Storage Init Error:",r));chrome.runtime.onMessage.addListener((r,l,a)=>{if(r.action==="SAVE_BOOK")return(async()=>{try{if(!c()&&(await i(),!c())){a({success:!1,error:"STORAGE_NOT_CONFIGURED"});return}const{bookId:t,fileBase64:o,extension:e}=r,s=E(o);await n(t,s,e),a({success:!0})}catch(t){console.log("Bg Save Error:",t),a({success:!1,error:t.message})}})(),!0;if(r.action==="CHECK_EXIST")return(async()=>{try{if(c()||await i(),!c()){a({exists:!1});return}const o=(await u()).some(e=>e.bookId===r.bookId);a({exists:o})}catch(t){console.log("Check Exist Error:",t),a({exists:!1})}})(),!0;if(r.action==="UPDATE_METADATA")return(async()=>{try{c()||await i(),await f(r.bookId,r.metadata),a({success:!0})}catch(t){console.log("Update Metadata Error:",t),a({success:!1})}})(),!0;if(r.action==="GET_FILE")return(async()=>{try{c()||await i();const t=await b(r.bookId);if(t&&t.file){const o=await h(t.file);a({success:!0,fileBase64:o,ext:t.ext})}else a({success:!1})}catch(t){console.log("Get File Error:",t),a({success:!1})}})(),!0;if(r.action==="OPEN_LIBRARY")return chrome.tabs.create({url:"library.html"}),a({success:!0}),!0});
